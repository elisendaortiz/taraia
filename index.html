<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taraia Object Time-Series Viewer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide icons as inline SVG
        const MapPin = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Info = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        );

        const ChevronLeft = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        );

        const ChevronRight = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );

        const TaraiaViewer = () => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [config, setConfig] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                fetch('./nikumaroro_imagery/viewer_config.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load viewer_config.json. Make sure the Python script has been run first.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        setConfig(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            if (loading) {
                return (
                    <div className="h-screen bg-slate-900 text-white flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p className="text-slate-300">Loading imagery data...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="h-screen bg-slate-900 text-white flex items-center justify-center p-6">
                        <div className="max-w-2xl bg-red-900/30 border border-red-500/50 rounded-lg p-6">
                            <h2 className="text-xl font-bold text-red-400 mb-3">⚠️ Configuration Error</h2>
                            <p className="text-slate-300 mb-4">{error}</p>
                            <div className="bg-slate-900/50 p-4 rounded text-sm text-slate-400">
                                <p className="font-semibold mb-2">To fix this:</p>
                                <ol className="list-decimal ml-4 space-y-1">
                                    <li>Run: <code className="bg-slate-800 px-1 rounded">python scripts/getdata_nikumaroro.py</code></li>
                                    <li>This will create <code className="bg-slate-800 px-1 rounded">nikumaroro_imagery/viewer_config.json</code></li>
                                    <li>Refresh this page</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                );
            }

            const currentImage = config.images[currentIndex];
            const imagePath = `./nikumaroro_imagery/${currentImage.aligned_filename || currentImage.filename}`;
            const sliderMax = Math.max(config.images.length - 1, 1);
            const sliderPct = sliderMax > 0 ? (currentIndex / sliderMax) * 100 : 0;

            const handlePrevious = () => setCurrentIndex(prev => prev > 0 ? prev - 1 : config.images.length - 1);
            const handleNext     = () => setCurrentIndex(prev => prev < config.images.length - 1 ? prev + 1 : 0);
            const handleSlider   = (e) => setCurrentIndex(parseInt(e.target.value));

            return (
                <div className="h-screen flex flex-col bg-slate-900 text-white overflow-hidden">

                    {/* ── Header ── */}
                    <div className="flex-none px-6 pt-4 pb-3 border-b border-slate-700/60">
                        <h1 className="text-3xl font-bold flex items-center gap-3 mb-2">
                            <MapPin size={32} className="text-red-500" />
                            {config.location.name}
                        </h1>
                        <div className="flex items-center gap-4 pl-1">
                            <div className="flex items-center gap-2 text-sm text-slate-300">
                                <span className="font-mono bg-slate-800 px-2 py-1 rounded">
                                    {Math.abs(config.location.lat).toFixed(6)}°{config.location.lat < 0 ? 'S' : 'N'}
                                </span>
                                <span className="font-mono bg-slate-800 px-2 py-1 rounded">
                                    {Math.abs(config.location.lon).toFixed(6)}°{config.location.lon < 0 ? 'W' : 'E'}
                                </span>
                            </div>
                            <p className="text-slate-400 text-sm italic">{config.location.description}</p>
                        </div>
                    </div>

                    {/* ── Body: sidebar + viewer ── */}
                    <div className="flex flex-1 min-h-0 gap-3 p-3 pb-5">

                        {/* Left Sidebar */}
                        <div className="flex-none w-44 flex flex-col gap-3 text-xs">

                            {/* Image metadata */}
                            <div className="bg-slate-800/60 border border-slate-700 rounded-lg p-3 space-y-3">
                                <div>
                                    <div className="text-slate-500 uppercase tracking-wider text-[10px] mb-1">Date</div>
                                    <div className="font-mono text-slate-200 flex items-center gap-1.5">
                                        <Calendar size={12} className="text-slate-400" />
                                        {currentImage.date}
                                    </div>
                                </div>
                                <div>
                                    <div className="text-slate-500 uppercase tracking-wider text-[10px] mb-1">Source</div>
                                    <div className="text-slate-200">{currentImage.source}</div>
                                </div>
                                <div>
                                    <div className="text-slate-500 uppercase tracking-wider text-[10px] mb-1">Resolution</div>
                                    <div className="font-mono text-slate-200">{currentImage.width} × {currentImage.height}px</div>
                                </div>
                                <div>
                                    <div className="text-slate-500 uppercase tracking-wider text-[10px] mb-1">Zoom Level</div>
                                    <div className="font-mono text-slate-200">Z{currentImage.zoom || '18'}</div>
                                </div>
                                <div>
                                    <div className="text-slate-500 uppercase tracking-wider text-[10px] mb-1">Image</div>
                                    <div className="font-mono text-slate-200">{currentIndex + 1} / {config.images.length}</div>
                                </div>
                            </div>

                            {/* Time range */}
                            <div className="bg-slate-800/40 border border-slate-700 rounded-lg p-3">
                                <div className="text-slate-500 uppercase tracking-wider text-[10px] mb-2">Time Range</div>
                                <div className="text-slate-300 font-mono">
                                    {config.metadata.date_range.start}
                                </div>
                                <div className="text-slate-500 text-[10px] my-1">→</div>
                                <div className="text-slate-300 font-mono">
                                    {config.metadata.date_range.end}
                                </div>
                                <div className="mt-2 text-slate-500">{config.metadata.total_images} images total</div>
                            </div>

                        </div>

                        {/* Main Viewer */}
                        <div className="flex-1 flex flex-col min-h-0 bg-slate-800/50 rounded-xl border border-slate-700 shadow-2xl overflow-hidden">

                            {/* Slider on top */}
                            <div className="flex-none bg-slate-800 px-4 py-3 border-b border-slate-700">
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={handlePrevious}
                                        className="bg-slate-700 hover:bg-slate-600 p-1.5 rounded-lg transition-colors flex-shrink-0"
                                        title="Previous"
                                    >
                                        <ChevronLeft size={18} />
                                    </button>

                                    <div className="flex-1">
                                        <input
                                            type="range"
                                            min="0"
                                            max={sliderMax}
                                            value={currentIndex}
                                            onChange={handleSlider}
                                            className="w-full h-2 rounded-lg appearance-none cursor-pointer slider"
                                            style={{
                                                background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${sliderPct}%, #475569 ${sliderPct}%, #475569 100%)`
                                            }}
                                        />
                                        <div className="flex justify-between mt-1 text-[10px] text-slate-500 font-mono">
                                            <span>{config.metadata.date_range.start}</span>
                                            <span>{config.metadata.date_range.end}</span>
                                        </div>
                                    </div>

                                    <button
                                        onClick={handleNext}
                                        className="bg-slate-700 hover:bg-slate-600 p-1.5 rounded-lg transition-colors flex-shrink-0"
                                        title="Next"
                                    >
                                        <ChevronRight size={18} />
                                    </button>
                                </div>
                            </div>

                            {/* Image — fills all remaining space */}
                            <div className="flex-1 min-h-0 bg-black flex items-center justify-center relative">
                                <img
                                    src={imagePath}
                                    alt={`Satellite imagery from ${currentImage.date}`}
                                    className="max-w-full max-h-full object-contain"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.nextSibling.style.display = 'flex';
                                    }}
                                />
                                <div className="absolute inset-0 items-center justify-center" style={{display: 'none'}}>
                                    <div className="text-center text-slate-500 p-8">
                                        <MapPin size={48} className="mx-auto mb-2" />
                                        <p className="text-sm mb-1">Image not found</p>
                                        <p className="text-xs opacity-60">{imagePath}</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <style>{`
                        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
                        .slider::-webkit-slider-thumb {
                            appearance: none;
                            width: 16px;
                            height: 16px;
                            background: #3b82f6;
                            cursor: pointer;
                            border-radius: 50%;
                            border: 2px solid white;
                        }
                        .slider::-moz-range-thumb {
                            width: 16px;
                            height: 16px;
                            background: #3b82f6;
                            cursor: pointer;
                            border-radius: 50%;
                            border: 2px solid white;
                        }
                    `}</style>
                </div>
            );
        };

        ReactDOM.render(<TaraiaViewer />, document.getElementById('root'));
    </script>
</body>
</html>